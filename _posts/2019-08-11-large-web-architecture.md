---
layout:     post
title:      "大型网站技术架构"
subtitle:   "Large Web Architecture"
date:       2019-08-11 20:50
author:     "BeautyMyth"
header-img: "img/post-bg-2015.jpg"
catalog: true
multilingual: false
tags:
    - 架构
---

> 介绍网站架构中的除了系统需求之外，还需要考虑的性能、可用性、伸缩性、扩展性、安全。

## 前言

<p>
此文是<code>大型网站技术架构</code>的读书笔记，本书说明了大型网站架构需要包含的相关要素，并对每个要素进行分类讲解。
</p>

## 概述

#### 架构模式

<p>
为了解决大型网站面临的高并发访问、海量数据处理、高可靠运行等一系列问题与挑战，大型互联网公司在实践中提出了许多解决方案，以实现网站高性能、高可用、易伸缩、可扩展、安全等各种架构目标。这些解决方案又被更多的网站反复使用，从而逐渐形成大型网站架构模式。
</p>

##### 分层

<p>
将系统在纵向维度上切分成多个部分（如应用层、服务层、数据层），每个部分负责一部分相对比较单一的职责。不同层可部署在一台或多台物理机上。
</p>

##### 分割

<p>
在横向对软件进行切分，如将应用层按不同的功能分割成多个部分，可有多个团队负责，部署在不同的服务器上。
</p>

##### 分布式

<p>
分层和分割切分后的模块部署在不同的服务器上，通过远程调用协同工作。服务器越多，可调用的CPU、内存、存储资源也就越多。
</p>

<p>
分布式也会带来如下这些问题，因此分布式的设计需要量力而行，不能为了分布式而分布式。
</p>

- 服务调用的网络开销
- 服务器的宕机
- 数据一致性
- 分布式事务

<p>
常用的分布式方案：
</p>

- 分布式应用和服务：将分层和分割后的应用与服务模块分布式部署
- 分布式静态资源：网站的静态资源，如JS、CSS、图片等资源独立分布式部署
- 分布式数据与存储：海量的数据需要进行分布式部署
- 分布式计算：使用Hadoop及其MapReduce分布式计算框架进行批处理计算

##### 集群

<p>
多台服务器部署相同的应用构成一个集群，通过负载均衡设备共同对外提供服务。
</p>

##### 缓存

<p>
将数据存放在距离计算最近的位置以加快处理速度。
</p>

<p>
使用前提：
</p>

- 数据访问热点不均衡，某些数据会被频繁访问
- 数据在某个时间段内有效，不会很快过期

<p>
使用方式：
</p>

- CDN：内容分发网络，部署在距离终端用户最近的网络服务商
- 反向代理：部署在网站的前端，用户请求会先到反向代理服务器
- 本地缓存：在应用服务器本地缓存热点数据
- 分布式缓存：将数据缓存在一个专门的分布式缓存集群中

##### 异步

<p>
多个服务器集群通过分布式消息队列实现异步，是典型的生产者消费者模式，互相之间不存在直接调用。
</p>

<p>
好处：
</p>

- 提高系统可用性
- 加快网站响应速度
- 消除并发访问高峰

##### 冗余

<p>
为了保证网站的高可用性，需要对服务器或数据进行冗余，构建集群。
</p>

##### 自动化

<p>
开发：
</p>

- 自动化代码管理
- 自动化测试
- 自动化安全检测
- 自动化部署

<p>
运维：
</p>

- 自动化监控
- 自动化报警
- 自动化故障转移
- 自动化故障恢复
- 自动化降级
- 自动化分配资源

##### 安全

<p>
网站安全方面模式：
</p>

- 身份认证：密码和手机验证码
- 通信安全：https加密
- 敏感数据：加密存储
- 网站暴力攻击：验证码
- sql注入：编码转换和绑定变量
- 垃圾与敏感信息：过滤

#### 核心架构要素

##### 性能

<p>
浏览器端：
</p>

- 浏览器缓存，页面压缩，合理页面布局，减少Cookie传输。

<p>
静态资源：
</p>

- 1.CDN加快用户访问速度
- 2.反向代理加快响应速度，减轻应用服务器压力。

<p>
服务器端：
</p>

- 1.本地缓存与分布式缓存加快请求处理过程，减轻数据库压力。
- 2.消息队列，异步处理非紧要任务。
- 3.服务器集群，增加服务器数量

<p>
代码：
</p>

- 1.多线程，改善内存管理

<p>
数据库端：
</p>

- 1.索引，缓存，SQL优化
- 2.NoSql的应用


##### 可用性

<p>
通过冗余，应用部署在多台服务器上同时提供访问，数据存储在多台服务器上互相备份。
</p>

##### 伸缩性

<p>
通过不断向集群中加入服务器的手段来缓解用户并发访问压力和不断增加的数据存储需求。
</p>

- 应用服务器：服务器上不保存数据，比较方便扩展。
- 缓存服务器：可能需要改进缓存路由算法，当添加新的服务器时保证缓存数据的可访问性。
- 关系数据库：通过路由分区等手段将多个数据库服务器组成一个集群。

##### 扩展性

<p>
当网站增加新的业务产品时，是否可实现对现有产品透明无影响，不需任何改动或很少的改动就可以上线新产品。
</p>

- 事件驱动架构，利用消息队列实现不同业务产品间的交互
- 分布式服务，分离业务与可复用服务，新增产品可调用可复用服务来实现逻辑

##### 安全

<p>
衡量网站安全架构的标准就是针对现有和潜在的各种攻击与窃密手段，是否有可靠的应对策略。
</p>

## 架构

#### 高性能

##### 性能指标

- 响应时间：结束响应时间-开始请求时间
- 并发数：系统能够同时处理请求的数量。测试程序主要通过多线程模拟并发用户的办法来测试系统的处理能力，在2次请求之间会增加个思考时间。	
- 吞吐量：单位时间内系统处理的请求数量。会随并发数的升高，出现先上升后下降的过程。
- 性能计数器：System Load(系统负载)，top查看，表示最近1分钟，10分钟，15分钟的运行队列平均进程数。

##### 性能测试方法

- 性能测试：以系统设计的预期目标为准，对系统不断施加压力，验证系统在资源可接受范围内，是否能达到性能预期。
- 负载测试：对系统不断增加并发请求，直到系统的某项或多项指标达到安全临界值，这时再增加压力，系统处理能力反而会下降。
- 压力测试：超过安全负载的情况下，对系统继续施加压力，直到系统崩溃或不能处理任何请求，从而获取系统的最大承受能力。
- 稳定性测试：被测试系统在特定硬件，软件，网络环境下，给系统加载一定的业务压力，运行一段时间，检测系统是否稳定。

##### web前端优化

<p>
浏览器访问优化：
</p>

- 减少http请求
- 使用浏览器缓存
- 启用压缩
- css放在页面最上面，js放在页面最下面
- 减少cookie传输

<p>
CDN加速：
</p>

- 缓存一些静态资源，如图片，文件，css，js，静态网页等。

<p>
反向代理：
</p>

- 部署在网站机房，用于代理网站web服务器接收http请求，之后再转发给web服务器。有安全与缓存的功能。

##### 应用服务器优化

<p>
分布式缓存，考虑如下问题：
</p>

- 频繁修改的数据：写入一次缓存，至少能被读取2次以上
- 没有热点的访问：大部分访问没有集中在小部分数据上（如28定律）
- 数据不一致与脏读
- 缓存可用性：需要使用分布式缓存
- 缓存预热：在缓存服务器启动时，加载一些热点数据
- 缓存穿透：需要缓存不存在的数据，防止直接到数据库服务器

<p>
异步操作：
</p>

- 使用消息队列将不需要立即处理的逻辑，进行异步处理

<p>
使用集群：
</p>

- 使用负载均衡为一个应用构建一个由多台服务器组成的服务器集群

<p>
代码优化：
</p>

- 多线程
- 资源复用：单例，对象池，连接池

##### 存储优化

<p>
可考虑用固态硬盘代替机械键盘。
</p>

#### 高可用

##### 网站架构

- 应用层：通过负载均衡设备将一组服务器组成一个集群对外提供服务。
- 服务层：在应用层通过分布式服务调用框架，访问服务层集群
- 数据层：在数据写入时进行数据同步复制，将数据同步到多台服务器，实现数据冗余备份。当服务器宕机时，应用程序切换到可用的服务器上。

##### 高可用应用

- 无状态服务：使用多台服务器组成集群进行负载均衡
- 有状态服务（Session）：使用分布式缓存，数据库等

##### 高可用服务

- 分级管理：核心应用和服务使用更好的硬件，服务部署上进行隔离，避免故障的连锁反应
- 超时设置：当应用调用服务超时，根据策略进行重试或将请求转移到提供相同服务的其他服务器上
- 异步调用：应用对服务的调用通过消息队列异步处理，避免一个服务异常导致整个请求失败
- 服务降级：拒绝服务[拒绝低优先级应用的调用，减少服务调用并发数;随机拒绝部分请求调用，节约资源]，关闭功能[关闭部分不重要的服务]
- 幂等性设计：需要在服务层保证服务重复调用和调用一次的结果是相同的

##### 高可用数据

###### CAP原理

<p>
高可用数据含义：
</p>

- 数据持久性：保证数据可持久存储，任何情况下都不会出现数据丢失的问题
- 数据可访问性：当某个数据设备损坏时，需要有其他设备提供数据访问
- 数据一致性：当数据有多个副本时，当网络或服务器等出现故障，不同的副本数据可能会不一致

<p>
CAP（不能同时满足如下所有情况）:
</p>

- 数据一致性：所有应用能获取到同样的数据
- 数据可用性：任何时候，所有应用都可以读写访问
- 分区耐受性：数据系统可以跨网络分区线性伸缩

<p>
数据一致性：
</p>

- 数据强一致：所有副本数据在物理存储中总是一致
- 数据用户一致：副本数据可能不一致，但是用户访问时通过纠错与校验机制，保证给用户返回的是一致正确结果
- 数据最终一致：副本数据不一致，用户访问也不一致，系统经过一段时间会变为一致

###### 数据备份

<p>
数据冷备：
</p>

- 定期将数据复制到某种物理存储介质上

<p>
数据热备：
</p>

- 异步热备：数据写入时，只写成功一份，其它副本通过异步方式写入
- 同步热备：数据写入时，并发将数据写入所有副本

###### 失效转移

- 失效确认：通过心跳检测和应用程序访问报告来确定
- 访问转移：当确认某台服务器失效时，需要将数据读写访问路由到其他服务器上
- 数据恢复：恢复副本数量到设定的值，防止之后的故障转移不能完成

##### 质量保证

- 网站发布：每次下线部分服务器，进行发布代码，上线服务器，直到发布完成。
- 自动化测试：当有功能改动时，需要使用自动化测试工具(Selenium)进行回归测试
- 预发布验证：使用线上真实服务器（不在负载均衡中）测试功能
- 代码控制：
- 自动化发布：
- 灰度发布(AB测试)：在部分服务器上发布新版本，运行几天没问题再发布到所有服务器。

##### 监控

###### 监控数据采集

<p>
用户行为日志：
</p>

- 服务器端日志收集：apache日志
- 客户端浏览器日志收集：js收集

<p>
服务器性能监控：
</p>

- 系统load、内存占用、磁盘IO、网络IO

<p>
运行数据报告：
</p>

- 监控业务指标，如缓存命中率、平均响应时间、每分钟处理任务数、待处理任务数


###### 监控管理

<p>
系统报警：
</p>

- 当某些监控超过阀值，需要及时通知相关人员。

<p>
失效转移：
</p>

- 监控系统主动告知应用，进行失效转移。

<p>
自动优雅降级：
</p>

- 当网站压力突然很大时，自动关闭不是很重要的功能。

#### 伸缩性

##### 伸缩性设计

###### 不同功能物理分离

- 纵向分离（分层后分离）：将业务处理流程上的不同部分分离部署，如网站基础产品、可复用业务服务、基础技术服务、数据库、缓存

![image](https://github.com/xuanxuan2016/xuanxuan2016.github.io/blob/master/img/2019-08-11-large-web-architecture/tu_6_2.png?raw=true)


- 横向分离（业务分割后分离）：将不同的业务模块分离部署，如网站前台、卖家后台、买家后台

![image](https://github.com/xuanxuan2016/xuanxuan2016.github.io/blob/master/img/2019-08-11-large-web-architecture/tu_6_3.png?raw=true)

###### 单一功能集群扩展

<p>
将相同服务部署在多台服务器上构成一个集群对外提供服务。
</p>

##### 应用服务器集群伸缩性

<p>
通过负载均衡将用户的请求分发到不同的服务器上。
</p>

- 负载均衡：可及时发现集群中上线或下线的服务器，从而调整分发请求的服务器。

<p>
负载均衡种类：
</p>

- HTTP重定向：通过重定向服务器，获取真实web服务器，写入HTTP重定向响应中返回给浏览器
- DNS域名解析：DNS服务器根据负载均衡算法计算一个不同的IP地址返回
- 反向代理：将请求根据负载均衡算法转发到不同web服务器上
- IP：获取网络数据包，修改请求中的目标地址IP
- 数据链路层：在通信协议的数据链路层修改mac地址

<p>
负载均衡算法：
</p>

- 轮询（Round Robin）：所有请求被依次分发到每台应用服务器
- 加权轮询（Weighted Round Robin）：在轮询的基础上，按照权重进行分发，好的机器会分发的多些
- 随机（Random）：请求被随机分配到各个应用服务器
- 最小连接（Least Connections）：请求分发到最小连接的服务器上
- 源地址散列（Source Hashing）：根据请求的来源ip进行Hash计算，获取应用服务器

##### 分布式缓存集群伸缩性

<p>
分布式缓存服务器集群中不同服务器缓存的数据各不相同，向集群中添加节点时，考虑缓存数据重新分配，可能带来的缓存命中问题。
</p>

##### 数据服务器集群伸缩性

###### 关系数据库

- 主从分离：可扩展读的性能
- 分库：按业务分割数据库，当新增库时，需要考虑数据的迁移。

###### nosql数据库

- HBase:依赖可分裂的HRegion及可伸缩的分布式文件系统HDFS实现。

#### 可扩展

##### 分布式消息队列降低系统耦合

<p>
事件驱动架构：在低耦合的模块之间传输事件消息，以保持模块的松散耦合，借助事件消息的通信完成模块间的合作。
</p>

![image](https://github.com/xuanxuan2016/xuanxuan2016.github.io/blob/master/img/2019-08-11-large-web-architecture/tu_7_1.png?raw=true)

<p>
分布式消息队列：应用程序通过远程接口访问使用分布式消息队列，进行消息存取操作，从而实现分布式的异步调用。
</p>

![image](https://github.com/xuanxuan2016/xuanxuan2016.github.io/blob/master/img/2019-08-11-large-web-architecture/tu_7_2.png?raw=true)

##### 分布式服务打造可复用业务平台

<p>
通过接口分解系统耦合性，将模块独立部署，不同子系统通过相同的接口描述进行服务调用。
</p>

![image](https://github.com/xuanxuan2016/xuanxuan2016.github.io/blob/master/img/2019-08-11-large-web-architecture/tu_7_4.png?raw=true)

<p>
除了服务的注册与发现，服务调用等标准功能。分布式服务框架还需如下特性：
</p>

- 负载均衡：对调用量较大的服务，需要部署在集群上，通过负载均衡访问
- 失效转移：当某个服务实例不可用时，需要将请求切换到其他服务实例上
- 高效的远程通信：调用量巨大，需要提高远程通信性能
- 整合异构系统：整合不同语言开发的服务
- 对应用最少侵入：减少对业务的影响
- 版本管理：服务更新时，需要确保服务不能中断
- 实时监控：监控服务提供者和调用的各项指标

#### 安全

##### 网站攻击与防御

###### XSS攻击

<p>
跨站点脚本攻击（Cross Site Script），黑客通过篡改网页，注入恶意的html脚本，当用户浏览网页时，控制用户的浏览器进行恶意的操作。
</p>

- 解决方法：
- 消毒：对【<>】进行转义
- HttpOnly：禁止js获取cookie

###### SQL注入攻击

<p>
攻击者在HTTP请求中注入恶意SQL，在数据库被执行。
</p>

- 解决方法：
- 消毒：通过正则表达式过滤有害sql语句
- 参数绑定：使用预编译与绑定参数

###### CSRF攻击

<p>
利用浏览器Cookie或Session策略盗取用户身份，通过跨站请求，执行非法操作。
</p>

- 解决方法：
- 表单Token：从服务器生成一个token给到浏览器，每次提交需要附带此token
- 验证码：重要的请求，需要使用验证码验证
- Referer Check：检查Http请求头中的Referer，是否为本网站

###### Web应用防火墙

<p>
使用web防火墙来同时应对多种攻击，如ModSecurity。
</p>

###### 网站漏洞扫描

<p>
定期对网站根据规则，进行扫描以发现漏洞进行修复。
</p>

##### 信息加密与密钥安全

- 单向散列加密：不可逆加密，用于密码等。对不同长度的输入信息进行散列计算，得到固定长度输出。
- 对称加密：可逆加密，如Cookie等。加密与解密使用相同的密钥。
- 非对称加密：可逆加密，如信息安全传输、数字签名等。加密与解密使用不相同的密钥，私钥加密的需要公钥解密，公钥加密的需要私钥解密。
- 密钥管理：密钥与加密算法放在独立的服务器上；加密算法放在应用服务器，密钥放在独立的服务器上。

##### 信息过滤与反垃圾

- 文本匹配：解决敏感词的过滤。如果用户发表的内容包含敏感词，需要将敏感词进行消毒。
- 分类算法：将批量已分类的信息，输入分类算法进行训练，得到相应的分类模型。之后就可以使用分类算法与分类模型，来进行信息的分类了。
- 黑名单：将需要过滤信息的关键字，添加到黑名单，之后可通过黑名单进行查找过滤。

##### 电子商务风险



## 参考资料

[大型网站技术架构 核心原理与案例分析](https://item.jd.com/11322972.html)

[常见的Web攻击手段之CSRF攻击](https://www.jianshu.com/p/67408d73c66d)





